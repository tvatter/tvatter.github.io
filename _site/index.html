<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  	<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
     &middot; Thibault Vatter
    
  </title>
  
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  <!-- CSS, to change font you also need to update font family in public/css/hyde.css-->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">-->
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">-->
  <link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css">  
  <link rel="stylesheet" href="/academicons.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" >
  
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60189402-1', 'auto');
  ga('send', 'pageview');

</script>


  <body class="theme-base-0d">

    <div class="sidebar">
	<div class="container sidebar-sticky">
<!--<div class="container">-->
    <div class="sidebar-about">
      <h1>
        <a href="/">
          
        </a>
      </h1>
      <!--<p class="lead"><a href="https://scholar.google.ch/citations?user=C1G2OxkAAAAJ&hl=en" target="_blank">Google Scholar</a>, <a href="https://github.com/tvatter">Github</a>, <a href="mailto:thibault.vatter@gmail.com">email</a></p>-->

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/publications/">Publications</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/software/">Software</a>
          
        
      

      
      <!--<a class="sidebar-nav-item" href="/archive/v.zip">Download</a>
      <a class="sidebar-nav-item" href="">GitHub project</a>
      <span class="sidebar-nav-item">Currently v</span>-->
    </nav>


    
    <a href="https://scholar.google.ch/citations?user=C1G2OxkAAAAJ&hl=en">
      <span class="fa-stack fa-lg">
        <i class="fa fa-square-o fa-stack-2x"></i>
        <i class="ai ai-google-scholar fa-stack-1x"></i>
      </span>
    </a>
    


    <!---->

    
      <a href="https://github.com/tvatter">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-github-alt fa-stack-1x"></i>
        </span>
      </a>
    

    

   
      <a href="mailto:thibault.vatter@gmail.com">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-envelope fa-stack-1x"></i>
        </span>
      </a>
    

    </div>
	 <br>
    <p>&copy; <font size="1"> Thibault Vatter </font>
  <br>
   <font size="1"> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> 
  Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. </font> 
  </p>
	</div>
</div>

    <div class="content container">
      	<h1> Hi, I'm Thibault! </h1>
<p>
    I'm a postdoctoral researcher at Columbia University in the city of New York. On this website, you can find
    <ul>
      <li> <a href = "https://tvatter.github.io/about/">informations about me</a> </li>
      <li> <a href = "https://tvatter.github.io/publications/">my publications</a> </li>
      <li> <a href = "https://tvatter.github.io/software/">the open-source software that I contribute to</a> </li>
     </ul>
     ... and some (hopefully) interesting blog posts.
</p>
<hr>

<div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/06/16/the-value-of-lead-time/">
        The value of lead time
      </a>
    </h1>

    <span class="post-date">16 Jun 2017</span>
    <hr>

    <p>In <a href="#references">two very nice papers</a>, Suzanne and her collaborators developped 
an interesting idea about valuing lead time based on financial mathematics related 
to option pricing. In the <a href="https://en.wikipedia.org/wiki/Newsvendor_model">standard newsvendor model</a>, the profits of the firm at delivery time <script type="math/tex">T</script> for an order of <script type="math/tex">Q</script> units are</p>

<p>\[
\Pi_T = p \min(D_T,Q) - c Q + s \max(Q-D_T, 0) = (p-c) Q - (p-s) \max(Q-D_T, 0),
\]</p>

<p>where <script type="math/tex">D_T</script> is the demand, <script type="math/tex">p</script> is the selling price of the product, <script type="math/tex">c</script> its cost and <script type="math/tex">s</script> its salvage value. The usual solution, i.e. the profit-maximizing order quantity is given by <script type="math/tex">Q = F^{-1}(\alpha)</script>,
where <script type="math/tex">F</script> is the distribution of the unkown demand, <script type="math/tex">\alpha = (p-c)/(p-s)</script>.</p>

<p>Looking closer at the profits, one recognizes in <script type="math/tex">\max(Q-D_T, 0)</script> the payoff of a put 
option on the demand with strike <script type="math/tex">Q</script>. Under absence of arbitrage, the <script type="math/tex">t \leq T</script> price of such an option is <script type="math/tex">P(D_t,t,T,Q) = E^{\mathcal{Q}}_t \left[ \max(Q-D_T, 0) \right]</script>, where <script type="math/tex">\mathcal{Q}</script> denotes the risk-neutral probability measure, and thus the expected profit can be written as</p>

<p>\[
 E^{\mathcal{Q}}_t \left[ \Pi_T \right] = (p-c) Q - (p-s) P(D_t,t,T,Q).
\]</p>

<p>Let us assume that the firm as the choice between</p>

<ul>
  <li>producing at <script type="math/tex">t_s \leq  T</script> for a cost <script type="math/tex">c_s</script>,</li>
  <li>producing at <script type="math/tex">% <![CDATA[
t_l< t_s %]]></script> for a cost <script type="math/tex">% <![CDATA[
c_l < c_s %]]></script>.</li>
</ul>

<p>This is typical of a situation when a firm can choose between a local production or a delocalization. Now, the interesting question is: how can we value lead time? In other words, what are the right <script type="math/tex">c_l</script> and <script type="math/tex">c_s</script> to compensate the firm for the uncertainty about future demand? Or given <script type="math/tex">c_l</script>, which <script type="math/tex">c_s</script> would the firm require to be indifferent between producing at <script type="math/tex">t_s</script> and <script type="math/tex">t_l</script>?</p>

<p>For the sake of simplicity, we will fix <script type="math/tex">t_s = T</script> (i.e., <script type="math/tex">c_s</script> is the make-to-order cost), <script type="math/tex">t_l=0</script> and <script type="math/tex">D_0=1</script>. Given <script type="math/tex">c_l</script>, let <script type="math/tex">Q_l</script> denote the profit maximizing order quantity. If the distribution of the demand is known, then <script type="math/tex">Q_l</script> can be computed as for the newsvendor model. Otherwise, one has to numerically solve
\[
 Q_l = \mbox{argmax}_Q \left\lbrace (p-c_l) Q - (p-s) P(1,0,T,Q) \right\rbrace.
\]</p>

<p>In the make-to-order case, it is clear that <script type="math/tex">Q_s=D_T</script>. Since, under the absence of arbitrage, we have 
<script type="math/tex">E^{\mathcal{Q}}_t \left[ D_T \right] = D_t</script>, it follows that the expected profit at time <script type="math/tex">0</script> is simply <script type="math/tex">p-c_s</script>. 
As such, the cost <script type="math/tex">c_s</script> making the firm indifferent between producing at time <script type="math/tex">0</script> or time <script type="math/tex">T</script> is given by</p>

<p>\[
c_s = p - (p-c_l) Q_l + (p-s) P(1,0,T,Q_l).
\]</p>

<p>In the <a href="https://shiny.rstudio.com/">shiny app</a>, we assume that <script type="math/tex">T=1</script> and show the cost differential frontier, namely <script type="math/tex">(c_s-c_l)/c_s</script> as a function of <script type="math/tex">t_l \in [0,T]</script>:</p>

<iframe src="https://tvatter.shinyapps.io/shinycdf/" width="100%" height="600" style="border: none;"></iframe>

<h2 id="references">References</h2>

<p>de Treville, S., Schürhoff, N., Trigeorgis, L. and Avanzi, B. (2014)<br />
<a href="http://dx.doi.org/10.1111/poms.12223">Optimal Sourcing and Lead-Time Reduction under Evolutionary Demand  Risk</a><br />
<em>Production and Operations Management, Volume 23, Issue 12, 2103-2117</em></p>

<p>de Treville, S., Bicer, I., Chavez-Demoulin, V., Hagspiel, V., Schürhoff, N., Tasserit, C. and Wager, S. (2014)<br />
<a href="http://dx.doi.org/10.1016/j.jom.2014.06.002">Valuing lead time</a><br />
<em>Journal of Operations Management, Volume 32, Issue 6, 337-346</em></p>

    <a href="/2017/06/16/the-value-of-lead-time/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/03/29/another-look-at-confounding/">
        Another look at confounding
      </a>
    </h1>

    <span class="post-date">29 Mar 2017</span>
    <hr>

    <p>Assume that one is interested in studying a relationship between two random 
variables <script type="math/tex">X</script> and <script type="math/tex">Y</script>. Simply put, a variable <script type="math/tex">Z</script> is said to be confonfounding 
if it explains some (or all) of the dependence between <script type="math/tex">X</script> and <script type="math/tex">Y</script>. For instance, 
if <script type="math/tex">Z</script> is such that <script type="math/tex">X \perp Y  \mid Z</script>, then one says that <script type="math/tex">Z</script> is a confounding 
variable for the relationship between <script type="math/tex">X</script> and <script type="math/tex">Y</script>. This situation is illustrated 
in the following graphical model:</p>

<p><img src="/figure/source/another-look-at-confounding/2017-03-29-another-look-at-confounding/unnamed-chunk-1-1.png" alt="plot of chunk unnamed-chunk-1" /></p>

<p>For instance, with <script type="math/tex">X \mid Z \sim N(Z,1)</script>, <script type="math/tex">Y  \mid Z \sim N(Z,1)</script>, and 
<script type="math/tex">Z \sim N(0,2)</script>, we have that <script type="math/tex">corr \left(X,Y \right)=0.8</script>, namely <script type="math/tex">X</script> and <script type="math/tex">Y</script> are correlated. 
However, since <script type="math/tex">corr \left(X,Z \right)=\sqrt{0.8}</script> and <script type="math/tex">corr \left(Y,Z \right)=\sqrt{0.8}</script>, there is no partial correlation between <script type="math/tex">X</script> and <script type="math/tex">Y</script> when controlling for the effect of <script type="math/tex">Z</script>, that is</p>

<p>\[
corr \left(X,Y;Z \right)= \frac{corr \left(X,Y \right)-corr \left(X,Z \right)corr \left(Y,Z \right)}{\sqrt{1-corr \left(X,Z \right)^2}\sqrt{1-corr \left(X,Y \right)^2}} = 0.
\]</p>

<p>In other words, <script type="math/tex">Z</script> acts as a confounding variable in the sense that, without taking its effect into account, one could make misleading conclusions on the correlation between <script type="math/tex">X</script> and <script type="math/tex">Y</script>. This can be seen in the following two figures, where <script type="math/tex">X</script> and <script type="math/tex">Y</script> are correlated, 
but <script type="math/tex">X-Z</script> and <script type="math/tex">Y-Z</script> are not:</p>

<p><img src="/figure/source/another-look-at-confounding/2017-03-29-another-look-at-confounding/unnamed-chunk-2-1.png" alt="plot of chunk unnamed-chunk-2" /></p>

<p>Consider now the conditional correlation between the random variables <script type="math/tex">X</script> and <script type="math/tex">Y</script> given <script type="math/tex">Z</script>, which is defined by</p>

<p>\[
corr \left(X,Y \mid Z \right) = 
\frac{E \left[\left\lbrace X-E \left(X \mid Z \right) \right\rbrace \left\lbrace Y-E \left(Y \mid Z \right) \right\rbrace \mid Z \right]}{ \left( E \left[ \left\lbrace X-E \left(X \mid Z \right) \right\rbrace^2 \mid Z \right] E \left[ \left\lbrace Y-E \left(Y \mid Z \right) \right\rbrace^2 \mid Z \right] \right)^{1/2}}
\]</p>

<p>In the example above, it is clear that <script type="math/tex">corr \left(X,Y \mid Z \right) = corr \left(X,Y ; Z \right)</script>. However, let <script type="math/tex">X =  A + BZ</script> and <script type="math/tex">Y =  C + DZ</script> where <script type="math/tex">A,B,C,D</script> are independently distributed random variables, then</p>

<p>\[
    corr \left(X,Y \mid Z \right)=<br />
    \frac{cov \left(A,C \right) + \left\lbrace cov \left(A,D \right)+cov \left(B,C \right) \right\rbrace Z + cov \left(B,D \right)Z^2}{
    \begin{aligned}
 \Bigg[ &amp;\big\lbrace var \left(A \right) + 2\, cov \left(A,B \right)  Z + var \left(B \right)Z^2\big\rbrace \\
           &amp; \cdot \big\lbrace var \left(C \right) + 2\, cov \left(C,D \right)  Z + var \left(D \right)Z^2\big\rbrace \Bigg]^{1/2}
\end{aligned}
    }.
\]</p>

<p>and if <script type="math/tex">A,B,C,D</script> have equal variance and correlation <script type="math/tex">\rho</script>, we have that</p>

<p>\[
    corr \left(X,Y \mid Z \right)=\frac{\rho \left( 1 + Z \right)^2}{
    \left( 1 + 2\, \rho Z \, + Z^2 \right)}.
\]</p>

<p>In this example, it is clear that the conditional correlation depends on the value of the conditioning variable <script type="math/tex">Z</script> explicitly. Hence, it is in general not equal to the partial correlation.</p>

<p>To study how <script type="math/tex">Z</script> can act as a confounding variable in this context, it is interesting to start from 
another example. Consider <script type="math/tex">X,Y,Z \sim N(0,1)</script> marginally,
but such that</p>

<p>\[
corr \left(X,Y \mid Z \right)= \begin{cases}
-0.5 &amp;\mbox{if } Z \leq 0 \\
0.5 &amp;\mbox{otherwise}
\end{cases}.
\]</p>

<p>Because <script type="math/tex">P(X \leq 0) = 1/2</script>, we have that <script type="math/tex">corr \left(X,Y\right) = 0</script>, and because <script type="math/tex">corr \left(X,Z\right) = 0</script> and <script type="math/tex">corr \left(Y,Z\right) = 0</script>, we even have <script type="math/tex">corr \left(X,Y ; Z\right) = 0</script>. In other words,
without taking into account the effect of <script type="math/tex">Z</script> or by looking at the partial correlation only, one would wrongly conclude that <script type="math/tex">X</script> and <script type="math/tex">Y</script> are independent, as observed in the following figure:</p>

<p><img src="/figure/source/another-look-at-confounding/2017-03-29-another-look-at-confounding/unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3" /></p>

<p>To summarize, rather than explaining some (or all) of the dependence between the variables of interest, it is also worth looking at confounding variables as masking relationships!</p>

    <a href="/2017/03/29/another-look-at-confounding/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/01/11/set-up-travis-to-embed-r-in-non-r-project/">
        Set up Travis to embed R in a non-R project
      </a>
    </h1>

    <span class="post-date">11 Jan 2017</span>
    <hr>

    <p><a href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous integration</a> 
(<a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a>) is great way of ensuring that code working in your 
local environment will also work with other configurations. If, like me, you’re using <a href="https://github.com/">GitHub</a>, then a neat solution to implement <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> principles within a new project is <a href="https://travis-ci.org">Travis CI</a>:</p>

<blockquote>
  <p>Travis CI is a hosted, distributed continuous integration service used to build and 
test software projects hosted at GitHub.</p>

  <p>—<cite>Wikipedia</cite></p>
</blockquote>

<p>However, it is well known that the default environment provided in <a href="https://travis-ci.org">Travis CI</a> 
is somewhat outdated. For instance, while implementing a <a href="https://github.com/tvatter/vinecopulib">C++ library for vine copulas</a>, I 
wanted to unit-test the C++ library by comparing its output to the <a href="https://cran.r-project.org/web/packages/VineCopula/index.html">VineCopula  R package</a>, which 
itself depends on the <a href="https://cran.r-project.org/web/packages/copula/index.html">copula R package</a>. 
Very naively, I then tried to write a <code class="highlighter-rouge">.travis.yml</code> that started with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>language: cpp
matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required

install:
  - sudo apt-get install r-base
  - sudo apt-get install libgsl0-dev
  - sudo Rscript -e <span class="s1">'install.packages("copula", repos="https://cran.rstudio.com/", lib="/usr/lib/R/library")'</span>
</code></pre>
</div>
<p>Note that <code class="highlighter-rouge">sudo apt-get install libgsl0-dev gsl-bin</code> is used because the 
the <a href="https://cran.r-project.org/web/packages/copula/index.html">copula R package</a> depends on 
the <a href="https://cran.r-project.org/web/packages/gsl/index.html">gsl R package</a>, which requires an install 
of the <a href="http://www.gnu.org/software/gsl/">Gnu Scientific Library</a>.</p>

<p>Obviously, the <code class="highlighter-rouge">.travis.yml</code> above didn’t work, as the <a href="https://travis-ci.org">Travis CI</a> log showed:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>Warning message: package ‘copula’ is not available <span class="o">(</span><span class="k">for </span>R version 3.0.2<span class="o">)</span> 
</code></pre>
</div>
<p>Version 3.0.2? In 2017? Alright, not a big deal, but since it took me a while to fix this issue, I though that 
someone else might be interested in the solution, which is in fact extremely simple. 
One just needs to start the <code class="highlighter-rouge">.travis.yml</code> file with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>language: cpp
matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      
before_install:
  - sudo sh -c <span class="s1">'echo "deb https://cloud.r-project.org/bin/linux/ubuntu trusty/" &gt;&gt; /etc/apt/sources.list'</span>
  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
  - sudo apt-get update

install:
  - sudo apt-get install r-base
  - sudo apt-get install libgsl0-dev
  - sudo Rscript -e <span class="s1">'install.packages("copula", repos="https://cran.rstudio.com/", lib="/usr/lib/R/library")'</span>
</code></pre>
</div>
<p>To obtain the latest R packages, in <code class="highlighter-rouge">before_install</code>, one does the following:</p>

<ul>
  <li>Add the R repository to the <code class="highlighter-rouge">/etc/apt/sources.list</code> file</li>
  <li>Add the R key to Ubuntu’s key-ring since</li>
</ul>

<blockquote>
  <p>The Ubuntu archives on CRAN are signed with the key of “Michael Rutter <a href="marutter@gmail.com">marutter@gmail.com</a>” with key ID E084DAB9. —<cite><a href="https://cran.r-project.org/bin/linux/ubuntu/">https://cran.r-project.org/bin/linux/ubuntu/</a></cite></p>
</blockquote>

<ul>
  <li>Update the package lists using the repositories to get information on the newest versions of packages and their dependencies</li>
</ul>

<p>And that’s it! Note that, for a C++ project embedding some R code, one might be interested in 
the R packages <a href="https://cran.r-project.org/web/packages/Rcpp/index.html">Rcpp</a> (for seamless R and C++ Integration) and
<a href="https://cran.r-project.org/web/packages/RInside/index.html">RInside</a> (to Embed R in C++ Applications), as we did 
in <a href="https://github.com/tvatter/vinecopulib">vinecopulib</a>.</p>

    <a href="/2017/01/11/set-up-travis-to-embed-r-in-non-r-project/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/01/10/my-mathematics-genealogy/">
        My Mathematics Genealogy
      </a>
    </h1>

    <span class="post-date">10 Jan 2017</span>
    <hr>

    <p>OK, so the first post on this blog is about my (mathematics) genealogy, how narcissistic of me. 
Anyway, I was looking at various ways to crawl and harvest data from websites (i.e., web crawling and scraping), and I thought that it could be fun to learn about it by extracting my ancestry from the 
<a href="https://genealogy.math.ndsu.nodak.edu/">Mathematics Genealogy Project</a> (thereafter <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a>).</p>

<p>Since, to the best of my knowledge, there is no good web crawling and scraping framework in R, I choose to use <code class="highlighter-rouge">scrapy</code> for Python, which is both comprehensive, easy to use and fast. After installing the package 
(e.g., via <code class="highlighter-rouge">pip install scrapy</code>), setting-up a <code class="highlighter-rouge">scrapy</code> directory  with the 
proper content for the mathematical genealogy project is done by simply running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy startproject mgp_spider 
</code></pre>
</div>
<p>To scrap the data for a single scholar, I define the class <code class="highlighter-rouge">ScholarItem</code> and 
add it to <code class="highlighter-rouge">items.py</code>:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ScholarItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</code></pre>
</div>
<p>Note that an <code class="highlighter-rouge">advisor</code> field could also be included, but the information is somewhat redundant.</p>

<p>Following the <a href="https://doc.scrapy.org/en/latest/intro/tutorial.html">tutorial</a>, a spider
to crawl my ancestry in the <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> by sub-classing <code class="highlighter-rouge">scrapy.Spider</code> in the following way:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MgpSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">'mgpspider'</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">'202169'</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MgpSpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">'https://www.genealogy.math.ndsu.nodak.edu/id.php?id='</span> <span class="o">+</span> <span class="n">root</span>
      <span class="p">]</span>

  <span class="k">def</span> <span class="nf">url_to_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ScholarItem</span><span class="p">()</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'h2::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_to_id</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">children_urls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'table'</span><span class="p">)</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">'id</span><span class="err">\</span><span class="s">.php</span><span class="err">\</span><span class="s">?id=</span><span class="err">\</span><span class="s">d*'</span><span class="p">)</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'children'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url_to_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">children_urls</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">item</span>

    <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@id="mainContent"]'</span><span class="p">)</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">'id</span><span class="err">\</span><span class="s">.php</span><span class="err">\</span><span class="s">?id=</span><span class="err">\</span><span class="s">d*'</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">href</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">children_urls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</code></pre>
</div>
<p>Apart from the spider’s name, the three functions are as follow:</p>

<ul>
  <li><code class="highlighter-rouge">__init__</code> is the constructor, which defines the spider’s starting URL. Note that,
  by default, root is set as my <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> id number.</li>
  <li><code class="highlighter-rouge">url_to_id</code> converts an URL into an <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> id number.</li>
  <li><code class="highlighter-rouge">parse</code> does two things:
    <ul>
      <li>First, it scraps the current scholar and saves it using <code class="highlighter-rouge">scrapy</code>’s <code class="highlighter-rouge">yield</code>.</li>
      <li>Second, it crawls the advisors of the scholar by recursively calling itself.</li>
    </ul>
  </li>
</ul>

<p>And that’s it, the result is then obtained by running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy crawl mgpspider -o output.json
</code></pre>
</div>
<p>Note that, to crawl the ancestry of my own advisor, I can simply pass its <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a>
id number to the spider by running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy crawl mgpspider -a <span class="nv">root</span><span class="o">=</span>86905 -o output.json
</code></pre>
</div>
<p>To leverage <code class="highlighter-rouge">igraph</code>’s nice layouts, the next step is loading the data in <code class="highlighter-rouge">R</code> by running:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="s2">"output.JSON"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p>Then, to build an <code class="highlighter-rouge">igraph</code> graph, the easiest way is often to construct the graph’s
adjacency matrix:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span><span class="w">
</span><span class="n">ancestry_adj_mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">is.element</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="n">ancestry_graph</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">graph_from_adjacency_matrix</span><span class="p">(</span><span class="n">ancestry_adj_mat</span><span class="p">)</span><span class="w">
</span><span class="n">V</span><span class="p">(</span><span class="n">ancestry_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">name</span><span class="w">
</span></code></pre>
</div>
<p>Because the full ancestry is a rather messy graph, the following plot is obtained by 
selecting the sub-graph corresponding to my neighborhood of order 18 using <code class="highlighter-rouge">igraph</code>’s <code class="highlighter-rouge">make_ego_graph</code> 
function (i.e., selecting ancestors with a degree of separation less than or equal to 18):
<img src="/figure/source/my-mathematics-genealogy/2017-01-10-my-mathematics-genealogy/ancestry_graph-1.png" alt="plot of chunk ancestry_graph" /></p>

    <a href="/2017/01/10/my-mathematics-genealogy/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Previous</span>
  
  
    <span class="pagination-item newer">Next</span>
  
</div>

<script type="text/javascript"
    src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<!--<ul class="toc">
  <li class="dropdown-header">Getting started</li>
<li><a href="intro.html">Introduction</a></li>
<li><a href="package.html">Package structure</a></li>
<li class="dropdown-header">Package components</li>
<li><a href="r.html">Code (<code>R/</code>)</a></li>
<li><a href="description.html">Package metadata (<code>DESCRIPTION</code>)</a></li>
<li><a href="man.html">Object documentation (<code>man/</code>)</a></li>
<li><a href="vignettes">Vignettes (<code>vignettes/</code>)</a></li>
<li><a href="tests.html">Testing (<code>tests/</code>)</a></li>
<li><a href="namespace.html">Namespaces (<code>NAMESPACE</code>)</a></li>
<li><a href="data.html">Data (<code>data/</code>)</a></li>
<li><a href="src.html">Compiled code (<code>src/</code>)</a></li>
<li><a href="inst.html">Installed files (<code>inst/</code>)</a></li>
<li><a href="misc.html">Other components</a></li>
<li class="dropdown-header">Best practices</li>
<li><a href="git.html">Git and GitHub</a></li>
<li><a href="check.html">Checking</a></li>
<li><a href="release.html">Release</a></li>

</ul>-->




      	 	


    </div>

  </body>
</html>
