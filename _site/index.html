<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">

  	<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
     &middot; Thibault Vatter
    
  </title>

  <!-- CSS, to change font you also need to update font family in public/css/hyde.css-->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">-->
  <!--<link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400">-->
  <link rel="stylesheet" href="//code.cdn.mozilla.net/fonts/fira.css">  
  <link rel="stylesheet" href="/academicons.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" >
  
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-60189402-1', 'auto');
  ga('send', 'pageview');

</script>


  <body class="theme-base-0b">

    <div class="sidebar">
	<div class="container sidebar-sticky">
<!--<div class="container">-->
    <div class="sidebar-about">
      <h1>
        <a href="/">
          
        </a>
      </h1>
      <!--<p class="lead"><a href="https://scholar.google.ch/citations?user=C1G2OxkAAAAJ&hl=en" target="_blank">Google Scholar</a>, <a href="https://github.com/tvatter">Github</a>, <a href="mailto:thibault.vatter@gmail.com">email</a></p>-->

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item active" href="/">Home</a>

      

      

      
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/CV/">Curriculum Vitae</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/archive/">Archive</a>
          
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/pubs/">Publications</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/software/">Software</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/tags/">Tags</a>
          
        
      

      
      <!--<a class="sidebar-nav-item" href="/archive/v2.1.0.zip">Download</a>
      <a class="sidebar-nav-item" href="">GitHub project</a>
      <span class="sidebar-nav-item">Currently v2.1.0</span>-->
    </nav>


    
    <a href="https://scholar.google.ch/citations?user=C1G2OxkAAAAJ&hl=en">
      <span class="fa-stack fa-lg">
        <i class="fa fa-square-o fa-stack-2x"></i>
        <i class="ai ai-google-scholar fa-stack-1x"></i>
      </span>
    </a>
    


    <!---->

    
      <a href="https://github.com/tvatter">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-github-alt fa-stack-1x"></i>
        </span>
      </a>
    

    

   <!--
      <a href="mailto:thibault.vatter@gmail.com">
        <span class="fa-stack fa-lg">
          <i class="fa fa-square-o fa-stack-2x"></i>
          <i class="fa fa-envelope fa-stack-1x"></i>
        </span>
      </a>
    -->

    </div>
	 <br>
    <p>&copy; <font size="1"> Kathryn Morrison </font>
  <br>
   <font size="1"> This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> 
  Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>. </font> 
  </p>
	</div>
</div>

<!--<div class="footer">
        <hr>
        <p>&copy; Hadley Wickham. Powered by <a href="http://jekyllrb.com/">jekyll</a>,
          <a href="http://yihui.name/knitr/">knitr</a>, and
          <a href="http://johnmacfarlane.net/pandoc/">pandoc</a>. Source
          available on <a href="https://github.com/hadley/adv-r/">github</a>.
        </p>
      </div>
-->


    <div class="content container">
      	<div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/01/11/set-up-travis-to-embed-r-in-non-r-project/">
        Set up Travis to embed R in a non-R project
      </a>
    </h1>

    <span class="post-date">11 Jan 2017</span>
    <hr>

    <p><a href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous integration</a> 
(<a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a>) is great way of ensuring that code working in your 
local environment will also work with other configurations. If, like me, you’re using <a href="https://github.com/">GitHub</a>, then a neat solution to implement <a href="https://en.wikipedia.org/wiki/Continuous_integration">CI</a> principles within a new project is <a href="https://travis-ci.org">Travis CI</a>:</p>

<blockquote>
  <p>Travis CI is a hosted, distributed continuous integration service used to build and 
test software projects hosted at GitHub.</p>

  <p>—<cite>Wikipedia</cite></p>
</blockquote>

<p>However, it is well known that the default environment provided in <a href="https://travis-ci.org">Travis CI</a> 
is somewhat outdated. For instance, while implementing a <a href="https://github.com/tvatter/vinecopulib">C++ library for vine copulas</a>, I 
wanted to unit-test the C++ library by comparing its output to the <a href="https://cran.r-project.org/web/packages/VineCopula/index.html">VineCopula  R package</a>, which 
itself depends on the <a href="https://cran.r-project.org/web/packages/copula/index.html">copula R package</a>. 
Very naively, I then tried to write a <code class="highlighter-rouge">.travis.yml</code> that started with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>language: cpp
matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required

install:
  - sudo apt-get install r-base
  - sudo apt-get install libgsl0-dev
  - sudo Rscript -e <span class="s1">'install.packages("copula", repos="https://cran.rstudio.com/", lib="/usr/lib/R/library")'</span>
</code></pre>
</div>
<p>Note that <code class="highlighter-rouge">sudo apt-get install libgsl0-dev gsl-bin</code> is used because the 
the <a href="https://cran.r-project.org/web/packages/copula/index.html">copula R package</a> depends on 
the <a href="https://cran.r-project.org/web/packages/gsl/index.html">gsl R package</a>, which requires an install 
of the <a href="http://www.gnu.org/software/gsl/">Gnu Scientific Library</a>.</p>

<p>Obviously, the <code class="highlighter-rouge">.travis.yml</code> above didn’t work, as the <a href="https://travis-ci.org">Travis CI</a> log showed:</p>
<pre><code class="language-{,eval=F}">Warning message: package ‘copula’ is not available (for R version 3.0.2) 
</code></pre>
<p>Version 3.0.2? In 2017? Alright, not a big deal, but since it took me a while to fix this issue, I though that 
someone else might be interested in the solution, which is in fact extremely simple. 
One just needs to start the <code class="highlighter-rouge">.travis.yml</code> file with:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>language: cpp
matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      
before_install:
  - sudo sh -c <span class="s1">'echo "deb https://cloud.r-project.org/bin/linux/ubuntu trusty/" &gt;&gt; /etc/apt/sources.list'</span>
  - sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys E084DAB9
  - sudo apt-get update

install:
  - sudo apt-get install r-base
  - sudo apt-get install libgsl0-dev
  - sudo Rscript -e <span class="s1">'install.packages("copula", repos="https://cran.rstudio.com/", lib="/usr/lib/R/library")'</span>
</code></pre>
</div>
<p>To obtain the latest R packages, in <code class="highlighter-rouge">before_install</code>, one does the following:</p>

<ul>
  <li>Add the R repository to the <code class="highlighter-rouge">/etc/apt/sources.list</code> file</li>
  <li>Add the R key to Ubuntu’s key-ring since</li>
</ul>

<blockquote>
  <p>The Ubuntu archives on CRAN are signed with the key of “Michael Rutter <a href="marutter@gmail.com">marutter@gmail.com</a>” with key ID E084DAB9. —<cite><a href="https://cran.r-project.org/bin/linux/ubuntu/">https://cran.r-project.org/bin/linux/ubuntu/</a></cite></p>
</blockquote>

<ul>
  <li>Update the package lists using the repositories to get information on the newest versions of packages and their dependencies</li>
</ul>

<p>And that’s it! Note that, for a C++ project embedding some R code, one might be interested in 
the R packages <a href="https://cran.r-project.org/web/packages/Rcpp/index.html">Rcpp</a> (for seamless R and C++ Integration) and
<a href="https://cran.r-project.org/web/packages/RInside/index.html">RInside</a> (to Embed R in C++ Applications), as we did 
in <a href="https://github.com/tvatter/vinecopulib">vinecopulib</a>.</p>

    <a href="/2017/01/11/set-up-travis-to-embed-r-in-non-r-project/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/2017/01/10/my-mathematics-genealogy/">
        My Mathematics Genealogy
      </a>
    </h1>

    <span class="post-date">10 Jan 2017</span>
    <hr>

    <p>OK, so the first post on this blog is about my (mathematics) genealogy, how narcissistic of me. 
Anyway, I was looking at various ways to crawl and harvest data from websites (i.e., web crawling and scraping), and I thought that it could be fun to learn about it by extracting my ancestry from the 
<a href="https://genealogy.math.ndsu.nodak.edu/">Mathematics Genealogy Project</a> (thereafter <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a>).</p>

<p>Since, to the best of my knowledge, there is no good web crawling and scraping framework in R, I choose to use <code class="highlighter-rouge">scrapy</code> for Python, which is both comprehensive, easy to use and fast. After installing the package 
(e.g., via <code class="highlighter-rouge">pip install scrapy</code>), setting-up a <code class="highlighter-rouge">scrapy</code> directory  with the 
proper content for the mathematical genealogy project is done by simply running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy startproject mgp_spider 
</code></pre>
</div>
<p>To scrap the data for a single scholar, I define the class <code class="highlighter-rouge">ScholarItem</code> and 
add it to <code class="highlighter-rouge">items.py</code>:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ScholarItem</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
    <span class="n">children</span> <span class="o">=</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Field</span><span class="p">()</span>
</code></pre>
</div>
<p>Note that an <code class="highlighter-rouge">advisor</code> field could also be included, but the information is somewhat redundant.</p>

<p>Following the <a href="https://doc.scrapy.org/en/latest/intro/tutorial.html">tutorial</a>, a spider
to crawl my ancestry in the <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> by sub-classing <code class="highlighter-rouge">scrapy.Spider</code> in the following way:</p>

<div class="language-python highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">MgpSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">'mgpspider'</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="o">=</span><span class="s">'202169'</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">):</span>
    <span class="nb">super</span><span class="p">(</span><span class="n">MgpSpider</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kargs</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">'https://www.genealogy.math.ndsu.nodak.edu/id.php?id='</span> <span class="o">+</span> <span class="n">root</span>
      <span class="p">]</span>

  <span class="k">def</span> <span class="nf">url_to_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
    <span class="n">tokens</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'='</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

  <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">ScholarItem</span><span class="p">()</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'name'</span><span class="p">]</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'h2::text'</span><span class="p">)</span><span class="o">.</span><span class="n">extract_first</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'id'</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_to_id</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="n">children_urls</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s">'table'</span><span class="p">)</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">'id</span><span class="err">\</span><span class="s">.php</span><span class="err">\</span><span class="s">?id=</span><span class="err">\</span><span class="s">d*'</span><span class="p">)</span>
    <span class="n">item</span><span class="p">[</span><span class="s">'children'</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">url_to_id</span><span class="p">(</span><span class="n">url</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">children_urls</span><span class="p">]</span>
    <span class="k">yield</span> <span class="n">item</span>

    <span class="k">for</span> <span class="n">href</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="s">'//div[@id="mainContent"]'</span><span class="p">)</span><span class="o">.</span><span class="n">re</span><span class="p">(</span><span class="s">'id</span><span class="err">\</span><span class="s">.php</span><span class="err">\</span><span class="s">?id=</span><span class="err">\</span><span class="s">d*'</span><span class="p">):</span>
          <span class="k">if</span> <span class="n">href</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">children_urls</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">scrapy</span><span class="o">.</span><span class="n">Request</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">urljoin</span><span class="p">(</span><span class="n">href</span><span class="p">),</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</code></pre>
</div>
<p>Apart from the spider’s name, the three functions are as follow:</p>

<ul>
  <li><code class="highlighter-rouge">__init__</code> is the constructor, which defines the spider’s starting URL. Note that,
  by default, root is set as my <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> id number.</li>
  <li><code class="highlighter-rouge">url_to_id</code> converts an URL into an <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a> id number.</li>
  <li><code class="highlighter-rouge">parse</code> does two things:
    <ul>
      <li>First, it scraps the current scholar and saves it using <code class="highlighter-rouge">scrapy</code>’s <code class="highlighter-rouge">yield</code>.</li>
      <li>Second, it crawls the advisors of the scholar by recursively calling itself.</li>
    </ul>
  </li>
</ul>

<p>And that’s it, the result is then obtained by running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy crawl mgpspider -o output.json
</code></pre>
</div>
<p>Note that, to crawl the ancestry of my own advisor, I can simply pass its <a href="https://genealogy.math.ndsu.nodak.edu/">MGP</a>
id number to the spider by running:</p>

<div class="language-bash highlighter-rouge"><pre class="highlight"><code>scrapy crawl mgpspider -a <span class="nv">root</span><span class="o">=</span>86905 -o output.json
</code></pre>
</div>
<p>To leverage <code class="highlighter-rouge">igraph</code>’s nice layouts, the next step is loading the data in <code class="highlighter-rouge">R</code> by running:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">data</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">jsonlite</span><span class="o">::</span><span class="n">fromJSON</span><span class="p">(</span><span class="s2">"output.JSON"</span><span class="p">)</span><span class="w">
</span></code></pre>
</div>
<p>Then, to build an <code class="highlighter-rouge">igraph</code> graph, the easiest way is often to construct the graph’s
adjacency matrix:</p>

<div class="language-r highlighter-rouge"><pre class="highlight"><code><span class="n">library</span><span class="p">(</span><span class="n">igraph</span><span class="p">)</span><span class="w">
</span><span class="n">ancestry_adj_mat</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sapply</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">children</span><span class="p">,</span><span class="w"> </span><span class="k">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="n">is.element</span><span class="p">(</span><span class="n">data</span><span class="o">$</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">))</span><span class="w">
</span><span class="n">ancestry_graph</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">graph_from_adjacency_matrix</span><span class="p">(</span><span class="n">ancestry_adj_mat</span><span class="p">)</span><span class="w">
</span><span class="n">V</span><span class="p">(</span><span class="n">ancestry_graph</span><span class="p">)</span><span class="o">$</span><span class="n">name</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">data</span><span class="o">$</span><span class="n">name</span><span class="w">
</span></code></pre>
</div>
<p>Because the full ancestry is a rather messy graph, the following plot is obtained by 
selecting the sub-graph corresponding to my neighborhood of order 18 using <code class="highlighter-rouge">igraph</code>’s <code class="highlighter-rouge">make_ego_graph</code> 
function (i.e., selecting ancestors with a degree of separation less than or equal to 18):
<img src="/figure/source/my-mathematics-genealogy/2017-01-10-my-mathematics-genealogy/ancestry_graph-1.png" alt="plot of chunk ancestry_graph" /></p>

    <a href="/2017/01/10/my-mathematics-genealogy/" class="read-more-btn"> <b>Read more &#187;</b> </a>
  </div>
  
</div>

<div class="pagination">
  
    <span class="pagination-item older">Previous</span>
  
  
    <span class="pagination-item newer">Next</span>
  
</div>

<script type="text/javascript"
    src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


<!--<ul class="toc">
  <li class="dropdown-header">Getting started</li>
<li><a href="intro.html">Introduction</a></li>
<li><a href="package.html">Package structure</a></li>
<li class="dropdown-header">Package components</li>
<li><a href="r.html">Code (<code>R/</code>)</a></li>
<li><a href="description.html">Package metadata (<code>DESCRIPTION</code>)</a></li>
<li><a href="man.html">Object documentation (<code>man/</code>)</a></li>
<li><a href="vignettes">Vignettes (<code>vignettes/</code>)</a></li>
<li><a href="tests.html">Testing (<code>tests/</code>)</a></li>
<li><a href="namespace.html">Namespaces (<code>NAMESPACE</code>)</a></li>
<li><a href="data.html">Data (<code>data/</code>)</a></li>
<li><a href="src.html">Compiled code (<code>src/</code>)</a></li>
<li><a href="inst.html">Installed files (<code>inst/</code>)</a></li>
<li><a href="misc.html">Other components</a></li>
<li class="dropdown-header">Best practices</li>
<li><a href="git.html">Git and GitHub</a></li>
<li><a href="check.html">Checking</a></li>
<li><a href="release.html">Release</a></li>

</ul>-->





 	



    </div>

  </body>
</html>
